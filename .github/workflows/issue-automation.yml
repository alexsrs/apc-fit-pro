name: ğŸ¤– Issue & PR Automation

on:
  issues:
    types: [opened, labeled, assigned]
  pull_request:
    types: [opened, labeled, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  # Auto-assign issues com prioridade alta
  auto-assign-high-priority:
    if: github.event_name == 'issues' && contains(github.event.label.name, 'priority:high')
    runs-on: ubuntu-latest
    steps:
      - name: Auto-assign high priority issues
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: [context.repo.owner]
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš¨ **Issue de alta prioridade detectada!**
              
              Esta issue foi automaticamente atribuÃ­da devido Ã  sua prioridade alta.
              
              **PrÃ³ximos passos:**
              1. âœ… Revisar os critÃ©rios de aceitaÃ§Ã£o
              2. ğŸ“… Estimar pontos de histÃ³ria
              3. ğŸŒ¿ Criar branch seguindo a convenÃ§Ã£o: \`feature/nome-da-funcionalidade\`
              4. ğŸ”„ Mover para "In Progress" no projeto
              
              ---
              *AutomaÃ§Ã£o via GitHub Actions* ğŸ¤–`
            });

  # Adicionar label de size baseado na estimativa
  estimate-size:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Add size label based on content
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body.toLowerCase();
            let sizeLabel = '';

            if (body.includes('1-2 horas') || body.includes('pontos: 1') || body.includes('pontos: 2')) {
              sizeLabel = 'size:xs';
            } else if (body.includes('3-8 horas') || body.includes('pontos: 3') || body.includes('pontos: 4')) {
              sizeLabel = 'size:s';
            } else if (body.includes('1-2 dias') || body.includes('pontos: 5') || body.includes('pontos: 6')) {
              sizeLabel = 'size:m';
            } else if (body.includes('3-5 dias') || body.includes('pontos: 7') || body.includes('pontos: 8')) {
              sizeLabel = 'size:l';
            } else if (body.includes('1+ semana') || body.includes('pontos: 9') || body.includes('pontos de histÃ³ria:** 1')) {
              sizeLabel = 'size:xl';
            }

            if (sizeLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [sizeLabel]
              });
            }

  # Welcome message para novas issues
  welcome-new-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Welcome new issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueType = context.payload.issue.labels.some(label => label.name.includes('bug')) ? 'bug' : 'feature';
            const welcomeMessage = issueType === 'bug' 
              ? `ğŸ› **Obrigado por reportar este bug!**
              
              Sua contribuiÃ§Ã£o ajuda a melhorar o APC FIT PRO. Nossa equipe irÃ¡:
              
              1. ğŸ” Analisar o problema reportado
              2. ğŸ·ï¸ Adicionar labels apropriadas
              3. ğŸ“… Priorizar baseado na severidade
              4. ğŸ”§ Trabalhar na correÃ§Ã£o
              
              **Tempo estimado de resposta:** 24-48 horas para bugs crÃ­ticos, 3-5 dias para outros.`
              : `ğŸš€ **Obrigado pela sugestÃ£o de funcionalidade!**
              
              Sua ideia serÃ¡ avaliada pela equipe do APC FIT PRO. Processo:
              
              1. ğŸ“ AnÃ¡lise de viabilidade tÃ©cnica
              2. ğŸ¯ Alinhamento com roadmap
              3. ğŸ“Š Estimativa de esforÃ§o
              4. ğŸ“… PriorizaÃ§Ã£o no backlog
              
              **Acompanhe o progresso:** Esta issue serÃ¡ atualizada conforme avanÃ§amos.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${welcomeMessage}
              
              ---
              ğŸ“š **Recursos Ãºteis:**
              - [Guia de ContribuiÃ§Ã£o](./CONTRIBUTING.md)
              - [DocumentaÃ§Ã£o do Projeto](./README.md)
              - [Roadmap Atual](./docs/github-issues-setup.md)
              
              *AutomaÃ§Ã£o via GitHub Actions* ğŸ¤–`
            });

  # Verificar se PR tem issue linkada
  check-pr-has-issue:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR links to an issue
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title;

            // Verificar se o PR menciona uma issue
            const hasIssueReference = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(prBody) || 
                                     /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(prTitle) ||
                                     /#\d+/.test(prBody);

            if (!hasIssueReference) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ **PR sem issue linkada detectado**
                
                Este Pull Request nÃ£o parece estar linkado a uma issue especÃ­fica.
                
                **Por favor:**
                1. ğŸ”— Linke a uma issue existente usando \`closes #123\`
                2. ğŸ“ Ou crie uma issue primeiro descrevendo a mudanÃ§a
                3. âœ… Atualize a descriÃ§Ã£o do PR
                
                **Por que isso Ã© importante:**
                - ğŸ“Š Rastreabilidade das mudanÃ§as
                - ğŸ¯ Contexto claro do que estÃ¡ sendo alterado
                - ğŸ“ˆ MÃ©tricas de desenvolvimento precisas
                
                ---
                *AutomaÃ§Ã£o via GitHub Actions* ğŸ¤–`
              });
              
              // Adicionar label de "needs-issue"
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['needs-issue']
              });
            }

  # Celebrar merge de PR
  celebrate-merge:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Celebrate successful merge
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const author = context.payload.pull_request.user.login;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ‰ **Pull Request mergeado com sucesso!**
              
              **ParabÃ©ns @${author}!** Sua contribuiÃ§Ã£o foi incorporada ao APC FIT PRO.
              
              **Resumo:**
              - âœ… ${prTitle}
              - ğŸš€ Deploy serÃ¡ realizado automaticamente
              - ğŸ“Š MÃ©tricas atualizadas no dashboard
              
              **PrÃ³ximos passos:**
              1. ğŸ§ª Testes automÃ¡ticos em produÃ§Ã£o
              2. ğŸ“ DocumentaÃ§Ã£o atualizada
              3. ğŸ”„ Issue relacionada serÃ¡ fechada automaticamente
              
              ---
              *Obrigado por contribuir com o APC FIT PRO!* ğŸ’ª`
            });
