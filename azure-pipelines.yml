# ğŸš€ APC FIT PRO API - CI/CD Pipeline para Azure
# Pipeline automatizado para build, test e deploy da API Node.js/Express
# Deploy automÃ¡tico para Azure App Service com suporte a mÃºltiplos ambientes

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - apcpro-api/*
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - apcpro-api/*

variables:
  # Azure Resource Manager connection
  azureSubscription: "87514cf3-ac58-4d33-b9f2-10f3a2717828"

  # Web app names por ambiente
  webAppNameProd: "apcpro-api"
  webAppNameDev: "apcpro-api-dev"

  # Environment names
  environmentNameProd: "apcpro-api-production"
  environmentNameDev: "apcpro-api-development"

  # Agent VM image
  vmImageName: "ubuntu-latest"

  # Working directory
  workingDirectory: "apcpro-api"

stages:
  - stage: Build
    displayName: "ğŸ—ï¸ Build e Testes"
    jobs:
      - job: Build
        displayName: "Build da API"
        pool:
          vmImage: $(vmImageName)

        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "22.x"
            displayName: "ğŸ“¦ Instalar Node.js 22.x"

          - script: |
              cd $(workingDirectory)
              echo "ğŸ“‹ Instalando dependÃªncias..."
              npm ci --only=production
              echo "ğŸ”¨ Gerando cliente Prisma..."
              npm run prisma:generate
              echo "ğŸ—ï¸ Fazendo build da aplicaÃ§Ã£o..."
              npm run build
            displayName: "ğŸ“¦ Install, Generate e Build"

          - script: |
              cd $(workingDirectory)
              echo "ğŸ§ª Executando linting..."
              npm run lint || echo "âš ï¸ Lint nÃ£o configurado"
              echo "ğŸ§ª Executando testes..."
              npm run test || echo "âš ï¸ Testes nÃ£o configurados"
            displayName: "ğŸ§ª Qualidade de CÃ³digo"
            continueOnError: "true"

          - task: ArchiveFiles@2
            displayName: "ğŸ“¦ Arquivar aplicaÃ§Ã£o"
            inputs:
              rootFolderOrFile: "$(workingDirectory)"
              includeRootFolder: false
              archiveType: zip
              archiveFile: $(Build.ArtifactStagingDirectory)/apcpro-api-$(Build.BuildId).zip
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: "ğŸ“¤ Publicar artefatos"
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)/apcpro-api-$(Build.BuildId).zip
              ArtifactName: "api-drop"
              publishLocation: "Container"

  # ğŸš€ Deploy para Desenvolvimento (branch develop)
  - stage: DeployDev
    displayName: "ğŸš€ Deploy Development"
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployToDev
        displayName: "Deploy para DEV"
        environment: $(environmentNameDev)
        pool:
          vmImage: $(vmImageName)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: "ğŸŒ Deploy Azure Web App (DEV)"
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: webAppLinux
                    appName: $(webAppNameDev)
                    runtimeStack: "NODE|22LTS"
                    package: $(Pipeline.Workspace)/api-drop/apcpro-api-$(Build.BuildId).zip
                    startUpCommand: "npm run start"
                    appSettings: |
                      -NODE_ENV development
                      -PORT 8080

  # ğŸ¯ Deploy para ProduÃ§Ã£o (branch main)
  - stage: DeployProd
    displayName: "ğŸ¯ Deploy Production"
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProd
        displayName: "Deploy para PROD"
        environment: $(environmentNameProd)
        pool:
          vmImage: $(vmImageName)
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: "ğŸŒ Deploy Azure Web App (PROD)"
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: webAppLinux
                    appName: $(webAppNameProd)
                    runtimeStack: "NODE|22LTS"
                    package: $(Pipeline.Workspace)/api-drop/apcpro-api-$(Build.BuildId).zip
                    startUpCommand: "npm run start"
                    appSettings: |
                      -NODE_ENV production
                      -PORT 8080
